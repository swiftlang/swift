// RUN: %target-sil-opt -dont-abort-on-memory-lifetime-errors -verify-continue-on-failure -enable-sil-verify-all=0 %s 2>&1 | %FileCheck %s

sil_stage canonical

public struct GenWrapper<T> {
  @_hasStorage var _prop: T { get set }
  public var prop: T
}

sil [ossa] @borrow_addressonly_prop : $@convention(method) <T> (@in_guaranteed GenWrapper<T>) -> @guaranteed_address T {
bb0(%0 : $*GenWrapper<T>):
  %2 = struct_element_addr %0, #GenWrapper._prop
  return %2
}

// CHECK: Begin Error in function test_address_of_temp
// CHECK: SIL verification failed: unidentified address return:
// CHECK: Verifying instruction:
// CHECK:      %4 = apply %3<T>(%1) : $@convention(method) <τ_0_0> (@in_guaranteed GenWrapper<τ_0_0>) -> @guaranteed_address τ_0_0
// CHECK: ->   return %4 : $*T
// CHECK: End Error in function test_address_of_temp
sil [ossa] @test_address_of_temp : $@convention(thin) <T> (@in_guaranteed GenWrapper<T>) -> @guaranteed_address T {
bb0(%0 : $*GenWrapper<T>):
  %stk = alloc_stack $GenWrapper<T>
  copy_addr %0 to [init] %stk
  %1 = function_ref @borrow_addressonly_prop : $@convention(method) <τ_0_0> (@in_guaranteed GenWrapper<τ_0_0>) -> @guaranteed_address τ_0_0
  %2 = apply %1<T>(%stk) : $@convention(method) <τ_0_0> (@in_guaranteed GenWrapper<τ_0_0>) -> @guaranteed_address τ_0_0
  destroy_addr %stk
  dealloc_stack %stk
  return %2
}

