// sil (this file) -> sib -> sib -> sil | FileCheck

// RUN: %empty-directory(%t)
// RUN: %target-sil-opt %s -emit-sib -o %t/tmp.sib -module-name default_override -enable-library-evolution -enable-experimental-feature CoroutineAccessors
// RUN: %target-sil-opt %t/tmp.sib -emit-sib -o %t/tmp.2.sib -module-name default_override -enable-library-evolution -enable-experimental-feature CoroutineAccessors
// RUN: %target-sil-opt %t/tmp.2.sib -module-name default_override -emit-sorted-sil -enable-library-evolution -enable-experimental-feature CoroutineAccessors | %FileCheck %s

// REQUIRES: swift_feature_CoroutineAccessors

sil_stage canonical

import Builtin

struct Int {
  var _value: Builtin.Int64
}

open class B {
  open var i: Int { yielding borrow set }
}

sil @B_i_read : $@yield_once @convention(method) (@guaranteed B) -> @yields Int
sil @B_i_yielding_borrow : $@yield_once_2 @convention(method) (@guaranteed B) -> @yields Int
sil @B_i_set : $@convention(method) (Int, @guaranteed B) -> ()
sil @B_i_modify : $@yield_once @convention(method) (@guaranteed B) -> @yields @inout Int
sil @B_i_yielding_mutate : $@yield_once_2 @convention(method) (@guaranteed B) -> @yields @inout Int

sil_vtable B {
  #B.i!read: (B) -> @yield_once () yields (Int) -> () : @B_i_read
  #B.i!yielding_borrow: (B) -> @yield_once () yields (Int) -> () : @B_i_yielding_borrow
  #B.i!setter: (B) -> (Int) -> () : @B_i_set
  #B.i!modify: (B) -> @yield_once () yields (inout Int) -> () : @B_i_modify
  #B.i!yielding_mutate: (B) -> @yield_once () yields (inout Int) -> () : @B_i_yielding_mutate
}

sil @B_i_yielding_borrow_default_override : $@yield_once_2 @convention(method) (@guaranteed B) -> @yields Int
sil @B_i_yielding_mutate_default_override : $@yield_once_2 @convention(method) (@guaranteed B) -> @yields @inout Int

// CHECK-LABEL: sil_default_override_table B {
// CHECK-NEXT:    #B.i!yielding_borrow: #B.i!read: (B) -> @yield_once () yields (Int) -> () : @B_i_yielding_borrow_default_override
// CHECK-NEXT:    #B.i!yielding_mutate: #B.i!modify: (B) -> @yield_once () yields (inout Int) -> () : @B_i_yielding_mutate_default_override
// CHECK-NEXT:  }
sil_default_override_table B {
  #B.i!yielding_borrow: #B.i!read: (B) -> @yield_once () yields (Int) -> () : @B_i_yielding_borrow_default_override
  #B.i!yielding_mutate: #B.i!modify: (B) -> @yield_once () yields (inout Int) -> () : @B_i_yielding_mutate_default_override
}
