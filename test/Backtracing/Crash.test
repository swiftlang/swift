// RUN: %empty-directory(%t)
// RUN: %target-build-swift %S/Inputs/Crash.swift -parse-as-library -Onone %swift-debug-flags -o %t/Crash.exe
// RUN: %target-codesign %t/Crash.exe

// RUN: ! env SWIFT_BACKTRACE=enable=yes,cache=no %target-run %t/Crash.exe > %t/Crash.out 2>&1
// RUN: %FileCheck %s --ignore-case < %t/Crash.out

// RUN: ! env SWIFT_BACKTRACE=preset=friendly,enable=yes,cache=no %target-run %t/Crash.exe > %t/Friendly.out 2>&1
// RUN: %FileCheck %s --ignore-case --check-prefix FRIENDLY < %t/Friendly.out

// UNSUPPORTED: use_os_stdlib
// UNSUPPORTED: back_deployment_runtime
// UNSUPPORTED: asan
// REQUIRES: executable_test
// REQUIRES: backtracing
// REQUIRES: OS=macosx || OS=linux-gnu || OS=windows-msvc


// CHECK: *** Program crashed: {{(Bad pointer dereference|Access violation)}} at 0x{{0+}}4 ***

// CHECK: Thread 0 {{(".*" )?}}crashed:

// CHECK: 0               0x{{[0-9a-f]+}} level5() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:20:15
// CHECK-NEXT: 1 [ra]          0x{{[0-9a-f]+}} level4() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:14:3
// CHECK-NEXT: 2 [ra]          0x{{[0-9a-f]+}} level3() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:10:3
// CHECK-NEXT: 3 [ra]          0x{{[0-9a-f]+}} level2() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:6:3
// CHECK-NEXT: 4 [ra]          0x{{[0-9a-f]+}} level1() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:2:3
// CHECK-NEXT: 5 [ra]          0x{{[0-9a-f]+}} static Crash.main() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:26:5
// CHECK-NEXT: 6 [ra] [system] 0x{{[0-9a-f]+}} static Crash.$main() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}<compiler-generated>
// CHECK-NEXT: 7 [ra] [system] 0x{{[0-9a-f]+}} main + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift

// CHECK: Registers:

// CHECK: Images ({{[0-9]+}} omitted):

// CHECK: {{0x[0-9a-f]+}}â€“{{0x[0-9a-f]+}}{{ +}}{{([0-9a-f]+|<no build ID>)}}{{ +}}Crash.exe{{ +}}{{.*[\\/]}}Crash.exe

// FRIENDLY: *** Program crashed: {{(Bad pointer dereference|Access violation)}} at 0x{{0+}}4 ***

// FRIENDLY: Thread 0 {{(".*" )?}}crashed:

// FRIENDLY: 0 level5() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:20:15

// FRIENDLY: 18|   print("About to crash")
// FRIENDLY-NEXT: 19|   let ptr = UnsafeMutablePointer<Int>(bitPattern: 4)!
// FRIENDLY-NEXT: 20|   ptr.pointee = 42
// FRIENDLY-NEXT:   |               ^
// FRIENDLY-NEXT: 21| }
// FRIENDLY-NEXT: 22|

// FRIENDLY: 1 level4() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:14:3

// FRIENDLY: 12|
// FRIENDLY-NEXT: 13| func level4() {
// FRIENDLY-NEXT: 14|   level5()
// FRIENDLY-NEXT:   |   ^
// FRIENDLY-NEXT: 15| }
// FRIENDLY-NEXT: 16|

// FRIENDLY: 2 level3() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:10:3

// FRIENDLY: 8|
// FRIENDLY-NEXT: 9| func level3() {
// FRIENDLY-NEXT: 10|   level4()
// FRIENDLY-NEXT:   |   ^
// FRIENDLY-NEXT: 11| }
// FRIENDLY-NEXT: 12|

// FRIENDLY: 3 level2() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:6:3

// FRIENDLY: 4|
// FRIENDLY-NEXT: 5| func level2() {
// FRIENDLY-NEXT: 6|   level3()
// FRIENDLY-NEXT:   |   ^
// FRIENDLY-NEXT: 7| }
// FRIENDLY-NEXT: 8|

// FRIENDLY: 4 level1() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:2:3

// FRIENDLY:      1| func level1() {
// FRIENDLY-NEXT: 2|   level2()
// FRIENDLY-NEXT:   |   ^
// FRIENDLY-NEXT: 3| }

// FRIENDLY: 5 static Crash.main() + {{[0-9]+}} in Crash.exe at {{.*[\\/]}}Crash.swift:26:5

// FRIENDLY: 24| struct Crash {
// FRIENDLY-NEXT: 25|   static func main() {
// FRIENDLY-NEXT: 26|     level1()
// FRIENDLY-NEXT:   |     ^
// FRIENDLY-NEXT: 27|   }
// FRIENDLY-NEXT: 28| }
