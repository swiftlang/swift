/// Test code generated by the polyglot ast logic and the stub generator.
/// We mostly use the stub generator to organize the generated code in a way
/// that we can type-check.

// RUN: %empty-directory(%t)
// RUN: split-file %s %t --leading-lines

// RUN: %target-swift-ide-test -source-filename %t/MyClass.m -print-polyglot-ast \
// RUN:   -header-to-print %t/MyClass.m \
// RUN:   --cc-args %target-cc-options %t/MyClass.m \
// RUN:   -isysroot %clang-importer-sdk-path \
// RUN:   > %t/ast.json

/// Generate stub
// RUN: %utils/at-implementation-stub-generator.swift %t/ast.json %t/stub.swift
// RUN: %FileCheck %s --input-file %t/stub.swift

/// Type-check the generated code FIXME it should pass
// RUN: not %target-swift-frontend -typecheck %t/stub.swift \
// RUN:    -import-objc-header %t/MyClass.h

// REQUIRES: objc_interop

//--- MyClass.h
@import Foundation;

#pragma clang assume_nonnull begin

@interface MyClass : NSObject

@property (nonatomic, strong, readonly) NSString *text;
@property (nonatomic, readonly) NSInteger length;

- (instancetype)initWithText:(NSString *)text length:(NSInteger)length;
+ (BOOL)supportsSecureCoding;

@end

#pragma clang assume_nonnull end

//--- MyClass.m
#import "MyClass.h"
#import <objc/NSObject.h>

// CHECK: import Foundation
// CHECK-NEXT: import ObjectiveC

#pragma clang assume_nonnull begin

static NSString * const kText = @"text";
static NSString * const kLength = @"length";
// CHECK: Unhandled: static NSString * const kText = @"text"
// CHECK: Unhandled: static NSString * const kLength = @"length"

@interface MyClass ()
// CHECK-LABEL: @objc @implementation
// CHECK-NEXT: extension MyClass {

@property (nonatomic, strong, readwrite) NSString *text;
@property (nonatomic, assign, readwrite) NSInteger length;
// CHECK:     open var text: String
// CHECK-NEXT:     open var length: Int
@end

@implementation MyClass

- (instancetype)initWithText:(NSString *)text length:(NSInteger)length
{
    self = [super init];
    if (self) {
      _text = text;
      _length = length;
    }
    return self;
}
// CHECK-LABEL:     @objc(initWithText:length:)
// CHECK-NEXT:     open init(text: String, length: Int) {
// CHECK-NEXT:           // {
// CHECK-NEXT:           //     self = [super init];
// CHECK-NEXT:           //     if (self) {
// CHECK-NEXT:           //       _text = text;
// CHECK-NEXT:           //       _length = length;
// CHECK-NEXT:           //     }
// CHECK-NEXT:           //     return self;
// CHECK-NEXT:           // }
// CHECK-NEXT:     }

+ (BOOL)supportsSecureCoding
{
  return YES;
}
// CHECK-LABEL:     @objc(supportsSecureCoding)
// CHECK-NEXT:     open class func supportsSecureCoding() -> Bool {
// CHECK-NEXT:           // {
// CHECK-NEXT:           //   return YES;
// CHECK-NEXT:           // }
// CHECK-NEXT:     }

#pragma mark - Description

- (NSString *)description
{
    return @"Static description";
}
// CHECK-LABEL:     @objc(description)
// CHECK-NEXT:     public let description: String

// CHECK: }

@end

#pragma clang assume_nonnull end
