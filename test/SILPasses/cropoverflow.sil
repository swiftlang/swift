// RUN: %target-sil-opt %s -crop-overflow-checks | FileCheck %s

sil_stage canonical

import Builtin
import Swift
import SwiftShims

sil [noinline] @sink_unsigned_int : $@thin () -> ()
sil [noinline] @sink_signed_int : $@thin () -> ()

// CHECK-LABEL: @sub_signed_branch_cond
sil hidden @sub_signed_branch_cond : $@thin (Int) -> () {
bb0(%0 : $Int):
  %1 = integer_literal $Builtin.Int64, 2          // users: %3, %12
  %2 = struct_extract %0 : $Int, #Int.value       // users: %3, %7, %12, %17
  %3 = builtin "cmp_slt_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64) : $Builtin.Int1 // user: %4
  cond_br %3, bb2, bb1                            // id: %4

bb1:                                              // Preds: bb0
  %5 = integer_literal $Builtin.Int64, 1          // user: %7
  %6 = integer_literal $Builtin.Int1, -1          // users: %7, %12, %17
  %7 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %5 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %8
  %8 = tuple_extract %7 : $(Builtin.Int64, Builtin.Int1), 1 // user: %9
// CHECK-NOT: cond_fail
  cond_fail %8 : $Builtin.Int1                    // id: %9
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.Int) -> ()
  %10 = function_ref @sink_unsigned_int : $@thin () -> () // users: %11, %15, %20
  %11 = apply %10() : $@thin () -> ()
  %12 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %13
  %13 = tuple_extract %12 : $(Builtin.Int64, Builtin.Int1), 1 // user: %14
// CHECK-NOT: cond_fail
  cond_fail %13 : $Builtin.Int1                   // id: %14
  %15 = apply %10() : $@thin () -> ()

// CHECK that we do not remove the '3' because it is not guarder by the branch.
// CHECK: integer_literal $Builtin.Int64, 3
// CHECK: cond_fail
  %16 = integer_literal $Builtin.Int64, 3         // user: %17
  %17 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %16 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %18
  %18 = tuple_extract %17 : $(Builtin.Int64, Builtin.Int1), 1 // user: %19
  cond_fail %18 : $Builtin.Int1                   // id: %19
  %20 = apply %10() : $@thin () -> ()
  br bb2                                          // id: %21

bb2:                                              // Preds: bb0 bb1
  %22 = tuple ()                                  // user: %23
// CHECK: return
  return %22 : $()                                // id: %23
}

// CHECK-LABEL: @sub_signed_branch_cond2
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @sub_signed_branch_cond2: $@thin (Int) -> () {
bb0(%0 : $Int):
  %1 = integer_literal $Builtin.Int64, 2          // users: %3, %12
  %2 = struct_extract %0 : $Int, #Int.value       // users: %3, %7, %12, %17
  %3 = builtin "cmp_sge_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64) : $Builtin.Int1 // user: %4
  cond_br %3, bb1, bb2                            // id: %4

bb1:                                              // Preds: bb0
  %5 = integer_literal $Builtin.Int64, 1          // user: %7
  %6 = integer_literal $Builtin.Int1, -1          // users: %7, %12, %17
  %7 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %5 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %8
  %8 = tuple_extract %7 : $(Builtin.Int64, Builtin.Int1), 1 // user: %9
  cond_fail %8 : $Builtin.Int1                    // id: %9
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.Int) -> ()
  %10 = function_ref @sink_unsigned_int : $@thin () -> () // users: %11, %15, %20
  %11 = apply %10() : $@thin () -> ()
  %12 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %13
  %13 = tuple_extract %12 : $(Builtin.Int64, Builtin.Int1), 1 // user: %14
  cond_fail %13 : $Builtin.Int1                   // id: %14
  %15 = apply %10() : $@thin () -> ()
  %16 = integer_literal $Builtin.Int64, 3         // user: %17
  %17 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %16 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %18
  %18 = tuple_extract %17 : $(Builtin.Int64, Builtin.Int1), 1 // user: %19
  cond_fail %13 : $Builtin.Int1                   // id: %19
  %20 = apply %10() : $@thin () -> ()
  br bb2                                          // id: %21

bb2:                                              // Preds: bb0 bb1
  %22 = tuple ()                                  // user: %23
  return %22 : $()                                // id: %23
}

// CHECK-LABEL: @sub_unsigned_branch_cond
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @sub_unsigned_branch_cond : $@thin (UInt) -> () {
bb0(%0 : $UInt):
  %1 = integer_literal $Builtin.Int64, 2          // users: %3, %12
  %2 = struct_extract %0 : $UInt, #UInt.value     // users: %3, %7, %12, %17
  %3 = builtin "cmp_ult_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64) : $Builtin.Int1 // user: %4
  cond_br %3, bb2, bb1                            // id: %4

bb1:                                              // Preds: bb0
  %5 = integer_literal $Builtin.Int64, 1          // user: %7
  %6 = integer_literal $Builtin.Int1, -1          // users: %7, %12, %17
  %7 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %5 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %8
  %8 = tuple_extract %7 : $(Builtin.Int64, Builtin.Int1), 1 // user: %9
  cond_fail %8 : $Builtin.Int1                    // id: %9
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.UInt) -> ()
  %10 = function_ref @sink_signed_int : $@thin () -> () // users: %11, %15, %20
  %11 = apply %10() : $@thin () -> ()
  %12 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %13
  %13 = tuple_extract %12 : $(Builtin.Int64, Builtin.Int1), 1 // user: %14
  cond_fail %13 : $Builtin.Int1                   // id: %14
  %15 = apply %10() : $@thin () -> ()
  %16 = integer_literal $Builtin.Int64, 3         // user: %17
  %17 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %16 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %18
  %18 = tuple_extract %17 : $(Builtin.Int64, Builtin.Int1), 1 // user: %19
  cond_fail %13 : $Builtin.Int1                   // id: %19
  %20 = apply %10() : $@thin () -> ()
  br bb2                                          // id: %21

bb2:                                              // Preds: bb0 bb1
  %22 = tuple ()                                  // user: %23
  return %22 : $()                                // id: %23
}

// CHECK-LABEL: @sub_unsigned_branch_cond2
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @sub_unsigned_branch_cond2 : $@thin (UInt) -> () {
bb0(%0 : $UInt):
  %1 = integer_literal $Builtin.Int64, 2          // users: %3, %12
  %2 = struct_extract %0 : $UInt, #UInt.value     // users: %3, %7, %12, %17
  %3 = builtin "cmp_uge_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64) : $Builtin.Int1 // user: %4
  cond_br %3, bb1, bb2                            // id: %4

bb1:                                              // Preds: bb0
  %5 = integer_literal $Builtin.Int64, 1          // user: %7
  %6 = integer_literal $Builtin.Int1, -1          // users: %7, %12, %17
  %7 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %5 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %8
  %8 = tuple_extract %7 : $(Builtin.Int64, Builtin.Int1), 1 // user: %9
  cond_fail %8 : $Builtin.Int1                    // id: %9
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.UInt) -> ()
  %10 = function_ref @sink_signed_int : $@thin () -> () // users: %11, %15, %20
  %11 = apply %10() : $@thin () -> ()
  %12 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %13
  %13 = tuple_extract %12 : $(Builtin.Int64, Builtin.Int1), 1 // user: %14
  cond_fail %13 : $Builtin.Int1                   // id: %14
  %15 = apply %10() : $@thin () -> ()
  %16 = integer_literal $Builtin.Int64, 3         // user: %17
  %17 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %16 : $Builtin.Int64, %6 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %18
  %18 = tuple_extract %17 : $(Builtin.Int64, Builtin.Int1), 1 // user: %19
  cond_fail %13 : $Builtin.Int1                   // id: %19
  %20 = apply %10() : $@thin () -> ()
  br bb2                                          // id: %21

bb2:                                              // Preds: bb0 bb1
  %22 = tuple ()                                  // user: %23
  return %22 : $()                                // id: %23
}

// CHECK-LABEL: @unsigned_sub_previous_traps
// Keep the first cond-fail
// CHECK: cond_fail
// Keep the condfail with +10 because it is not guarded by the first condfail (+9)
// CHECK: cond_fail
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @unsigned_sub_previous_traps : $@thin (UInt) -> () {
bb0(%0 : $UInt):
  %1 = integer_literal $Builtin.Int64, 9          // user: %4
  %2 = struct_extract %0 : $UInt, #UInt.value     // users: %4, %10, %15, %20, %25
  %3 = integer_literal $Builtin.Int1, -1          // users: %4, %10, %15, %20, %25
  %4 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %5
  %5 = tuple_extract %4 : $(Builtin.Int64, Builtin.Int1), 1 // user: %6
  cond_fail %5 : $Builtin.Int1                    // id: %6
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.UInt) -> ()
  %7 = function_ref @sink_signed_int : $@thin () -> () // users: %8, %13, %18, %23, %28, %29
  %8 = apply %7() : $@thin () -> ()
  %9 = integer_literal $Builtin.Int64, 2          // user: %10
  %10 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %9 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %11
  %11 = tuple_extract %10 : $(Builtin.Int64, Builtin.Int1), 1 // user: %12
  cond_fail %11 : $Builtin.Int1                   // id: %12
  %13 = apply %7() : $@thin () -> ()
  %14 = integer_literal $Builtin.Int64, 3         // user: %15
  %15 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %14 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %16
  %16 = tuple_extract %15 : $(Builtin.Int64, Builtin.Int1), 1 // user: %17
  cond_fail %16 : $Builtin.Int1                   // id: %17
  %18 = apply %7() : $@thin () -> ()
  %19 = integer_literal $Builtin.Int64, 5         // user: %20
  %20 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %19 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %21
  %21 = tuple_extract %20 : $(Builtin.Int64, Builtin.Int1), 1 // user: %22
  cond_fail %21 : $Builtin.Int1                   // id: %22
  %23 = apply %7() : $@thin () -> ()
  %24 = integer_literal $Builtin.Int64, 10        // user: %25
  %25 = builtin "usub_with_overflow_Int64"(%2 : $Builtin.Int64, %24 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %26
  %26 = tuple_extract %25 : $(Builtin.Int64, Builtin.Int1), 1 // user: %27
  cond_fail %26 : $Builtin.Int1                   // id: %27
  %28 = apply %7() : $@thin () -> ()
  %29 = apply %7() : $@thin () -> ()
  %30 = tuple ()                                  // user: %31
  return %30 : $()                                // id: %31
}

// CHECK-LABEL: @signed_sub_previous_traps
sil hidden @signed_sub_previous_traps : $@thin (Int) -> () {
bb0(%0 : $Int):
  %1 = integer_literal $Builtin.Int64, 9          // user: %4
  %2 = struct_extract %0 : $Int, #Int.value       // users: %4, %10, %15, %20, %25
  %3 = integer_literal $Builtin.Int1, -1          // users: %4, %10, %15, %20, %25
  %4 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %5
  %5 = tuple_extract %4 : $(Builtin.Int64, Builtin.Int1), 1 // user: %6
// Keep this condfail because it is the first one.
// CHECK: cond_fail
  cond_fail %5 : $Builtin.Int1                    // id: %6
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.Int) -> ()
  %7 = function_ref @sink_unsigned_int : $@thin () -> () // users: %8, %13, %18, %23, %28, %29
  %8 = apply %7() : $@thin () -> ()
  %9 = integer_literal $Builtin.Int64, 2          // user: %10
  %10 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %9 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %11
  %11 = tuple_extract %10 : $(Builtin.Int64, Builtin.Int1), 1 // user: %12
  cond_fail %11 : $Builtin.Int1                   // id: %12
  %13 = apply %7() : $@thin () -> ()
  %14 = integer_literal $Builtin.Int64, 3         // user: %15
  %15 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %14 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %16
  %16 = tuple_extract %15 : $(Builtin.Int64, Builtin.Int1), 1 // user: %17
  cond_fail %16 : $Builtin.Int1                   // id: %17
  %18 = apply %7() : $@thin () -> ()
  %19 = integer_literal $Builtin.Int64, 5         // user: %20
  %20 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %19 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %21
  %21 = tuple_extract %20 : $(Builtin.Int64, Builtin.Int1), 1 // user: %22
  cond_fail %21 : $Builtin.Int1                   // id: %22
  %23 = apply %7() : $@thin () -> ()
  %24 = integer_literal $Builtin.Int64, 10        // user: %25
  %25 = builtin "ssub_with_overflow_Int64"(%2 : $Builtin.Int64, %24 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %26
  %26 = tuple_extract %25 : $(Builtin.Int64, Builtin.Int1), 1 // user: %27
// Keep this condfail because it is not in the guraded range.
// CHECK: cond_fail
  cond_fail %26 : $Builtin.Int1                   // id: %27
  %28 = apply %7() : $@thin () -> ()
  %29 = apply %7() : $@thin () -> ()
  %30 = tuple ()                                  // user: %31
// CHECK-NOT: cond_fail
// CHECK: return
  return %30 : $()                                // id: %31
}

// CHECK-LABEL: @unsigned_add_previous_traps
sil hidden @unsigned_add_previous_traps : $@thin (UInt) -> () {
bb0(%0 : $UInt):
  %1 = integer_literal $Builtin.Int64, 9          // user: %4
  %2 = struct_extract %0 : $UInt, #UInt.value     // users: %4, %10, %15, %20, %25
  %3 = integer_literal $Builtin.Int1, -1          // users: %4, %10, %15, %20, %25
  %4 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %5
  %5 = tuple_extract %4 : $(Builtin.Int64, Builtin.Int1), 1 // user: %6
// Keep the first condfail.
//CHECK: cond_fail
  cond_fail %5 : $Builtin.Int1                    // id: %6
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.UInt) -> ()
  %7 = function_ref @sink_signed_int : $@thin () -> () // users: %8, %13, %18, %23, %28, %29
  %8 = apply %7() : $@thin () -> ()
  %9 = integer_literal $Builtin.Int64, 2          // user: %10
  %10 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %9 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %11
  %11 = tuple_extract %10 : $(Builtin.Int64, Builtin.Int1), 1 // user: %12
  cond_fail %11 : $Builtin.Int1                   // id: %12
  %13 = apply %7() : $@thin () -> ()
  %14 = integer_literal $Builtin.Int64, 3         // user: %15
  %15 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %14 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %16
  %16 = tuple_extract %15 : $(Builtin.Int64, Builtin.Int1), 1 // user: %17
  cond_fail %16 : $Builtin.Int1                   // id: %17
  %18 = apply %7() : $@thin () -> ()
  %19 = integer_literal $Builtin.Int64, 5         // user: %20
  %20 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %19 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %21
  %21 = tuple_extract %20 : $(Builtin.Int64, Builtin.Int1), 1 // user: %22
  cond_fail %21 : $Builtin.Int1                   // id: %22
  %23 = apply %7() : $@thin () -> ()
  %24 = integer_literal $Builtin.Int64, 10        // user: %25
  %25 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %24 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %26
  %26 = tuple_extract %25 : $(Builtin.Int64, Builtin.Int1), 1 // user: %27
// Keep the out-of-range condfail.
//CHECK: cond_fail
  cond_fail %26 : $Builtin.Int1                   // id: %27
  %28 = apply %7() : $@thin () -> ()
  %29 = apply %7() : $@thin () -> ()
  %30 = tuple ()                                  // user: %31
// CHECK-NOT: cond_fail
// CHECK: return
  return %30 : $()                                // id: %31
}

// CHECK-LABEL: @signed_add_previous_traps
// Keep the first condfail
// CHECK: cond_fail
// Keep out-of-range condfail
// CHECK: cond_fail
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @signed_add_previous_traps : $@thin (Int) -> () {
bb0(%0 : $Int):
  %1 = integer_literal $Builtin.Int64, 9          // user: %4
  %2 = struct_extract %0 : $Int, #Int.value       // users: %4, %10, %15, %20, %25
  %3 = integer_literal $Builtin.Int1, -1          // users: %4, %10, %15, %20, %25
  %4 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %5
  %5 = tuple_extract %4 : $(Builtin.Int64, Builtin.Int1), 1 // user: %6
  cond_fail %5 : $Builtin.Int1                    // id: %6
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.Int) -> ()
  %7 = function_ref @sink_unsigned_int : $@thin () -> () // users: %8, %13, %18, %23, %28, %29
  %8 = apply %7() : $@thin () -> ()
  %9 = integer_literal $Builtin.Int64, 2          // user: %10
  %10 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %9 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %11
  %11 = tuple_extract %10 : $(Builtin.Int64, Builtin.Int1), 1 // user: %12
  cond_fail %11 : $Builtin.Int1                   // id: %12
  %13 = apply %7() : $@thin () -> ()
  %14 = integer_literal $Builtin.Int64, 3         // user: %15
  %15 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %14 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %16
  %16 = tuple_extract %15 : $(Builtin.Int64, Builtin.Int1), 1 // user: %17
  cond_fail %16 : $Builtin.Int1                   // id: %17
  %18 = apply %7() : $@thin () -> ()
  %19 = integer_literal $Builtin.Int64, 5         // user: %20
  %20 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %19 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %21
  %21 = tuple_extract %20 : $(Builtin.Int64, Builtin.Int1), 1 // user: %22
  cond_fail %21 : $Builtin.Int1                   // id: %22
  %23 = apply %7() : $@thin () -> ()
  %24 = integer_literal $Builtin.Int64, 10        // user: %25
  %25 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %24 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %26
  %26 = tuple_extract %25 : $(Builtin.Int64, Builtin.Int1), 1 // user: %27
  cond_fail %26 : $Builtin.Int1                   // id: %27
  %28 = apply %7() : $@thin () -> ()
  %29 = apply %7() : $@thin () -> ()
  %30 = tuple ()                                  // user: %31
  return %30 : $()                                // id: %31
}

// CHECK-LABEL: @add1_signed_branch
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @add1_signed_branch : $@thin (Int, Int) -> () {
bb0(%0 : $Int, %1 : $Int):
  %2 = struct_extract %0 : $Int, #Int.value       // users: %4, %8, %14
  %3 = struct_extract %1 : $Int, #Int.value       // user: %4
  %4 = builtin "cmp_slt_Int64"(%2 : $Builtin.Int64, %3 : $Builtin.Int64) : $Builtin.Int1 // user: %5
  cond_br %4, bb1, bb2                            // id: %5

bb1:                                              // Preds: bb0
  %6 = integer_literal $Builtin.Int64, 1          // user: %8
  %7 = integer_literal $Builtin.Int1, -1          // users: %8, %14
  %8 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %6 : $Builtin.Int64, %7 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %9
  %9 = tuple_extract %8 : $(Builtin.Int64, Builtin.Int1), 1 // user: %10
  cond_fail %9 : $Builtin.Int1                    // id: %10
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.Int) -> ()
  %11 = function_ref @sink_unsigned_int : $@thin () -> () // users: %12, %17
  %12 = apply %11() : $@thin () -> ()
  %13 = integer_literal $Builtin.Int64, 2         // user: %14
  %14 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %13 : $Builtin.Int64, %7 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %15
  %15 = tuple_extract %14 : $(Builtin.Int64, Builtin.Int1), 1 // user: %16
  cond_fail %9 : $Builtin.Int1                   // id: %16
  %17 = apply %11() : $@thin () -> ()
  br bb2                                          // id: %18

bb2:                                              // Preds: bb0 bb1
  %19 = tuple ()                                  // user: %20
  return %19 : $()                                // id: %20
}

// CHECK-LABEL: @add1_unsigned_branch
// CHECK-NOT: cond_fail
// CHECK: return
sil hidden @add1_unsigned_branch : $@thin (UInt, UInt) -> () {
bb0(%0 : $UInt, %1 : $UInt):
  %2 = struct_extract %0 : $UInt, #UInt.value     // users: %4, %8, %14
  %3 = struct_extract %1 : $UInt, #UInt.value     // user: %4
  %4 = builtin "cmp_ult_Int64"(%2 : $Builtin.Int64, %3 : $Builtin.Int64) : $Builtin.Int1 // user: %5
  cond_br %4, bb1, bb2                            // id: %5

bb1:                                              // Preds: bb0
  %6 = integer_literal $Builtin.Int64, 1          // user: %8
  %7 = integer_literal $Builtin.Int1, -1          // users: %8, %14
  %8 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %6 : $Builtin.Int64, %7 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %9
  %9 = tuple_extract %8 : $(Builtin.Int64, Builtin.Int1), 1 // user: %10
  cond_fail %9 : $Builtin.Int1                    // id: %10
  // function_ref function signature specialization <Arg[0] = Dead> of cropoverflow.sink (Swift.UInt) -> ()
  %11 = function_ref @sink_signed_int : $@thin () -> () // users: %12, %17
  %12 = apply %11() : $@thin () -> ()
  %13 = integer_literal $Builtin.Int64, 2         // user: %14
  %14 = builtin "uadd_with_overflow_Int64"(%2 : $Builtin.Int64, %13 : $Builtin.Int64, %7 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %15
  %15 = tuple_extract %14 : $(Builtin.Int64, Builtin.Int1), 1 // user: %16
  cond_fail %9 : $Builtin.Int1                   // id: %16
  %17 = apply %11() : $@thin () -> ()
  br bb2                                          // id: %18

bb2:                                              // Preds: bb0 bb1
  %19 = tuple ()                                  // user: %20
  return %19 : $()                                // id: %20
}

// CHECK-LABEL: @remove_past_checks
sil hidden @remove_past_checks : $@thin (Int) -> () {
bb0(%0 : $Int):
  %1 = integer_literal $Builtin.Int64, 1          // user: %4
  %2 = struct_extract %0 : $Int, #Int.value       // users: %4, %8, %12, %16, %20
  %3 = integer_literal $Builtin.Int1, -1          // users: %4, %8, %12, %16, %20
// CHECK: sadd_with_overflow_Int64
  %4 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %1 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %5
  %5 = tuple_extract %4 : $(Builtin.Int64, Builtin.Int1), 1 // user: %6
// CHECK-NOT: cond_fail
  cond_fail %5 : $Builtin.Int1                    // id: %6
  %7 = integer_literal $Builtin.Int64, 2          // user: %8
// CHECK: sadd_with_overflow_Int64
  %8 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %7 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %9
  %9 = tuple_extract %8 : $(Builtin.Int64, Builtin.Int1), 1 // user: %10
// CHECK-NOT: cond_fail
  cond_fail %9 : $Builtin.Int1                    // id: %10
  %11 = integer_literal $Builtin.Int64, 3         // user: %12
// CHECK: sadd_with_overflow_Int64
  %12 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %11 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %13
  %13 = tuple_extract %12 : $(Builtin.Int64, Builtin.Int1), 1 // user: %14
// CHECK-NOT: cond_fail
  cond_fail %13 : $Builtin.Int1                   // id: %14
  %15 = integer_literal $Builtin.Int64, 4         // user: %16
// CHECK: sadd_with_overflow_Int64
  %16 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %15 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %17
  %17 = tuple_extract %16 : $(Builtin.Int64, Builtin.Int1), 1 // user: %18
// CHECK-NOT: cond_fail
  cond_fail %17 : $Builtin.Int1                   // id: %18
  %19 = integer_literal $Builtin.Int64, 5         // user: %20
// CHECK: sadd_with_overflow_Int64
  %20 = builtin "sadd_with_overflow_Int64"(%2 : $Builtin.Int64, %19 : $Builtin.Int64, %3 : $Builtin.Int1) : $(Builtin.Int64, Builtin.Int1) // user: %21
  %21 = tuple_extract %20 : $(Builtin.Int64, Builtin.Int1), 1 // user: %22
// We keep the last cond-fail, which is enough to guard all the others.
// CHECK: cond_fail
  cond_fail %21 : $Builtin.Int1                   // id: %22
  %23 = tuple ()                                  // user: %24
// CHECK: return
  return %23 : $()                                // id: %24
}
