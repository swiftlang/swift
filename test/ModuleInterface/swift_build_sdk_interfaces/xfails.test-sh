RUN: %empty-directory(%t)
RUN: cp -r %S/Inputs/xfails-sdk %t/sdk
RUN: %empty-directory(%t/sdk/usr/lib/swift/%target-sdk-name)
RUN: cp -r %platform-module-dir/{_Concurrency,_StringProcessing,Swift,SwiftOnoneSupport}.swiftmodule %t/sdk/usr/lib/swift/%target-sdk-name/
RUN: cp -r %test-resource-dir/shims %t/sdk/usr/lib/swift
RUN: env SWIFT_EXEC=%swiftc_driver_plain not %{python} %utils/swift_build_sdk_interfaces.py %mcp_opt -sdk %t/sdk/ -o %t/output -log-path %t | %FileCheck %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt
RUN: env SWIFT_EXEC=%swiftc_driver_plain not %{python} %utils/swift_build_sdk_interfaces.py %mcp_opt -sdk %t/sdk/ -v -o %t/output -log-path %t | %FileCheck -check-prefix CHECK-VERBOSE %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt

CHECK: # (FAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-VERBOSE-DAG: # (FAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-VERBOSE-DAG: # (PASS) {{.+}}{{\\|/}}Good.swiftinterface

PRINTS-ERROR: cannot find 'garbage' in scope
HIDES-ERROR-NOT: cannot find 'garbage' in scope

RUN: %empty-directory(%t/output)
RUN: echo '["Good"]' > %t/xfails-good.json
RUN: env SWIFT_EXEC=%swiftc_driver_plain not %{python} %utils/swift_build_sdk_interfaces.py %mcp_opt -sdk %t/sdk/ -o %t/output -xfails %t/xfails-good.json -log-path %t | %FileCheck -check-prefix=CHECK-XFAIL-GOOD %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt
RUN: env SWIFT_EXEC=%swiftc_driver_plain not %{python} %utils/swift_build_sdk_interfaces.py %mcp_opt -sdk %t/sdk/ -v -o %t/output -xfails %t/xfails-good.json 2> %t/stderr.txt | %FileCheck -check-prefix=CHECK-XFAIL-GOOD %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt

CHECK-XFAIL-GOOD-DAG: # (FAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-XFAIL-GOOD-DAG: # (UPASS) {{.+}}{{\\|/}}Good.swiftinterface

RUN: %empty-directory(%t/output)
RUN: echo '["Good", "Bad"]' > %t/xfails-good-and-bad.json
RUN: %swift_build_sdk_interfaces -sdk %t/sdk/ -o %t/output -xfails %t/xfails-good-and-bad.json 2> %t/stderr.txt | %FileCheck -check-prefix=CHECK-XFAIL-GOOD-AND-BAD %s
RUN: %FileCheck -check-prefix HIDES-ERROR -allow-empty %s < %t/stderr.txt
RUN: %swift_build_sdk_interfaces -sdk %t/sdk/ -v -o %t/output -xfails %t/xfails-good-and-bad.json -log-path %t | %FileCheck -check-prefix=CHECK-XFAIL-GOOD-AND-BAD %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt

CHECK-XFAIL-GOOD-AND-BAD-DAG: # (XFAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-XFAIL-GOOD-AND-BAD-DAG: # (UPASS) {{.+}}{{\\|/}}Good.swiftinterface

RUN: %empty-directory(%t/output)
RUN: echo '["Bad"]' > %t/xfails-bad.json
RUN: %swift_build_sdk_interfaces -sdk %t/sdk/ -o %t/output -xfails %t/xfails-bad.json 2> %t/stderr.txt | %FileCheck -check-prefix=CHECK-XFAIL-BAD %s
RUN: %FileCheck -check-prefix HIDES-ERROR -allow-empty %s < %t/stderr.txt
RUN: %swift_build_sdk_interfaces -sdk %t/sdk/ -v -o %t/output -xfails %t/xfails-bad.json -log-path %t | %FileCheck -check-prefix=CHECK-XFAIL-BAD-VERBOSE %s
RUN: %FileCheck -check-prefix PRINTS-ERROR %s < %t/Bad-Bad-err.txt

CHECK-XFAIL-BAD: # (XFAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-XFAIL-BAD-VERBOSE-DAG: # (XFAIL) {{.+}}{{\\|/}}Bad.swiftinterface
CHECK-XFAIL-BAD-VERBOSE-DAG: # (PASS) {{.+}}{{\\|/}}Good.swiftinterface
