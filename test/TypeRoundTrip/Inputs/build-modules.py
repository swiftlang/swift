#!/usr/bin/env python3
#
# Usage: build-modules.py tmp_dir testcases_dir build_cmd lib_pattern

import sys
import os
import subprocess
import shlex

tmp = sys.argv[1]
testcases = sys.argv[2]
build_cmd = sys.argv[3]
lib_pattern = sys.argv[4]

imports = []
body = []

for test in os.listdir(testcases):
    if not test.endswith(".swift"):
        continue

    modname = os.path.splitext(test)[0]
    module_path = os.path.join(tmp, f"{modname}.swiftmodule")
    lib_name = lib_pattern.replace("PLACEHOLDER", modname)
    test_path = os.path.join(testcases, test)

    # shlex.split handles quoted availability flags in build_cmd
    cmd = shlex.split(build_cmd) + [
        "-g",
        "-static",
        "-emit-module-path",
        module_path,
        "-emit-module",
        "-emit-library",
        "-module-name",
        modname,
        "-o",
        os.path.join(tmp, lib_name),
        f"-I{tmp}",
        f"-L{tmp}",
        test_path,
        "-lRoundTrip",
    ]
    subprocess.check_call(cmd)

    imports.append(f"import {modname}")
    body.append(f'  print("--- {modname}")')
    body.append(f"  {modname}.test()")
    body.append(f'  print("")')

    with open(os.path.join(tmp, "link.txt"), "a") as lf:
        lf.write(f"-l{modname}\n")

with open(os.path.join(tmp, "all-tests.swift"), "w") as f:
    f.write("// AUTOGENERATED\n")

    for line in imports:
        f.write(line + "\n")

    f.write("func runAllTests() throws {\n")

    for line in body:
        f.write(line + "\n")

    f.write("}\n")
